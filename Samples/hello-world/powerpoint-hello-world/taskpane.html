<!-- Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT License. -->
<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alt Text Manager</title>
    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 15px;
            margin: 0;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 100%;
        }

        h1 {
            color: #2b579a;
            font-size: 20px;
            margin-top: 0;
            border-bottom: 2px solid #2b579a;
            padding-bottom: 10px;
        }

        h2 {
            color: #333;
            font-size: 16px;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .section {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        button {
            background-color: #2b579a;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px 0;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #1f4070;
        }

        button:active {
            background-color: #163056;
        }

        button.secondary {
            background-color: #6c757d;
        }

        button.secondary:hover {
            background-color: #5a6268;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
        }

        input[type="text"], textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: inherit;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        #shapesList {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }

        .shape-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .shape-item:hover {
            background-color: #f0f0f0;
        }

        .shape-item:last-child {
            border-bottom: none;
        }

        .shape-name {
            font-weight: bold;
            color: #2b579a;
        }

        .shape-type {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .shape-alt {
            font-size: 12px;
            color: #333;
            margin-top: 5px;
            padding: 5px;
            background-color: #f8f9fa;
            border-radius: 3px;
        }

        .no-alt {
            color: #dc3545;
            font-style: italic;
        }

        .has-alt {
            color: #28a745;
        }

        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 13px;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .rule-template {
            background: #f8f9fa;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .rule-template label {
            font-weight: normal;
            margin-bottom: 3px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ëŒ€ì²´ í…ìŠ¤íŠ¸ ê´€ë¦¬ì</h1>

        <!-- í˜„ì¬ ìŠ¬ë¼ì´ë“œ ë¶„ì„ ì„¹ì…˜ -->
        <div class="section">
            <h2>ğŸ“Š í˜„ì¬ ìŠ¬ë¼ì´ë“œ ë¶„ì„</h2>
            <button id="analyzeButton">ìŠ¬ë¼ì´ë“œ ìš”ì†Œ ë¶„ì„</button>
            <div id="shapesList"></div>
        </div>

        <!-- ì„ íƒí•œ ìš”ì†Œì— ëŒ€ì²´ í…ìŠ¤íŠ¸ ì„¤ì • -->
        <div class="section">
            <h2>âœï¸ ì„ íƒí•œ ìš”ì†Œ í¸ì§‘</h2>
            <div class="input-group">
                <label for="altText">ëŒ€ì²´ í…ìŠ¤íŠ¸:</label>
                <textarea id="altText" placeholder="ëŒ€ì²´ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            </div>
            <button id="setAltTextButton">ì„ íƒí•œ ìš”ì†Œì— ì ìš©</button>
        </div>

        <!-- ê·œì¹™ ê¸°ë°˜ ëŒ€ì²´ í…ìŠ¤íŠ¸ ì ìš© -->
        <div class="section">
            <h2>âš™ï¸ ê·œì¹™ ê¸°ë°˜ ìë™ ì„¤ì •</h2>

            <div class="rule-template">
                <div class="input-group">
                    <label for="ruleType">ì ìš© ê·œì¹™:</label>
                    <select id="ruleType">
                        <option value="prefix">ì ‘ë‘ì‚¬ + ìš”ì†Œ ì´ë¦„</option>
                        <option value="type">ìš”ì†Œ íƒ€ì…ë³„ í…œí”Œë¦¿</option>
                        <option value="custom">ì‚¬ìš©ì ì •ì˜ í…œí”Œë¦¿</option>
                    </select>
                </div>

                <div class="input-group" id="prefixGroup">
                    <label for="prefix">ì ‘ë‘ì‚¬:</label>
                    <input type="text" id="prefix" placeholder="ì˜ˆ: ìŠ¬ë¼ì´ë“œ ìš”ì†Œ - " value="ìŠ¬ë¼ì´ë“œ ìš”ì†Œ - ">
                </div>

                <div class="input-group" id="customTemplateGroup" style="display: none;">
                    <label for="customTemplate">í…œí”Œë¦¿ (ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜: {name}, {type}, {index}):</label>
                    <input type="text" id="customTemplate" placeholder="ì˜ˆ: {type} {index}: {name}">
                </div>
            </div>

            <button id="applyRulesButton">ëª¨ë“  ìš”ì†Œì— ê·œì¹™ ì ìš©</button>
            <button id="applyRulesEmptyButton" class="secondary">ëŒ€ì²´ í…ìŠ¤íŠ¸ ì—†ëŠ” ìš”ì†Œë§Œ ì ìš©</button>
        </div>

        <!-- ìƒíƒœ ë©”ì‹œì§€ -->
        <div id="statusMessage"></div>
    </div>
</body>

<script>
    let currentShapes = [];

    Office.onReady((info) => {
        if (info.host === Office.HostType.PowerPoint) {
            document.getElementById("analyzeButton").onclick = analyzeSlide;
            document.getElementById("setAltTextButton").onclick = setAltTextForSelected;
            document.getElementById("applyRulesButton").onclick = () => applyRulesToAll(false);
            document.getElementById("applyRulesEmptyButton").onclick = () => applyRulesToAll(true);
            document.getElementById("ruleType").onchange = updateRuleUI;
        }
    });

    function showStatus(message, type = 'info') {
        const statusDiv = document.getElementById('statusMessage');
        statusDiv.className = `status-message ${type}`;
        statusDiv.textContent = message;
        setTimeout(() => {
            statusDiv.textContent = '';
            statusDiv.className = '';
        }, 5000);
    }

    function updateRuleUI() {
        const ruleType = document.getElementById('ruleType').value;
        const prefixGroup = document.getElementById('prefixGroup');
        const customGroup = document.getElementById('customTemplateGroup');

        prefixGroup.style.display = ruleType === 'prefix' ? 'block' : 'none';
        customGroup.style.display = ruleType === 'custom' ? 'block' : 'none';
    }

    async function analyzeSlide() {
        try {
            await PowerPoint.run(async (context) => {
                const slides = context.presentation.slides;
                const slide = slides.getItemAt(0); // í˜„ì¬ ì„ íƒëœ ìŠ¬ë¼ì´ë“œ
                const shapes = slide.shapes;

                shapes.load("items");
                await context.sync();

                currentShapes = [];
                const shapesList = document.getElementById('shapesList');
                shapesList.innerHTML = '';

                if (shapes.items.length === 0) {
                    shapesList.innerHTML = '<div class="status-message info">ì´ ìŠ¬ë¼ì´ë“œì—ëŠ” ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                for (let i = 0; i < shapes.items.length; i++) {
                    const shape = shapes.items[i];
                    shape.load("name,type,id");

                    // Office.jsì—ì„œëŠ” ì§ì ‘ alt textì— ì ‘ê·¼í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ
                    // nameê³¼ typeë§Œ í‘œì‹œí•©ë‹ˆë‹¤
                    await context.sync();

                    const shapeInfo = {
                        id: shape.id,
                        name: shape.name,
                        type: shape.type,
                        index: i
                    };

                    currentShapes.push(shapeInfo);

                    const shapeDiv = document.createElement('div');
                    shapeDiv.className = 'shape-item';
                    shapeDiv.innerHTML = `
                        <div class="shape-name">${shapeInfo.name}</div>
                        <div class="shape-type">íƒ€ì…: ${getShapeTypeName(shapeInfo.type)} | ì¸ë±ìŠ¤: ${i}</div>
                    `;

                    shapeDiv.onclick = () => selectShape(i);
                    shapesList.appendChild(shapeDiv);
                }

                showStatus(`${shapes.items.length}ê°œì˜ ìš”ì†Œë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`, 'success');
            });
        } catch (error) {
            showStatus('ìŠ¬ë¼ì´ë“œ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message, 'error');
            console.error(error);
        }
    }

    function getShapeTypeName(type) {
        const typeMap = {
            'GeometricShape': 'ë„í˜•',
            'Image': 'ì´ë¯¸ì§€',
            'Group': 'ê·¸ë£¹',
            'Line': 'ì„ ',
            'Table': 'í‘œ',
            'Chart': 'ì°¨íŠ¸',
            'TextBox': 'í…ìŠ¤íŠ¸ ìƒì',
            'ContentPlaceholder': 'ì½˜í…ì¸  ìë¦¬ í‘œì‹œì',
            'Picture': 'ê·¸ë¦¼',
            'Unsupported': 'ì§€ì›ë˜ì§€ ì•ŠëŠ” íƒ€ì…'
        };
        return typeMap[type] || type;
    }

    async function selectShape(index) {
        try {
            await PowerPoint.run(async (context) => {
                const slides = context.presentation.slides;
                const slide = slides.getItemAt(0);
                const shapes = slide.shapes;
                const shape = shapes.getItemAt(index);

                shape.load("name");
                await context.sync();

                showStatus(`ì„ íƒë¨: ${shape.name}`, 'info');
            });
        } catch (error) {
            showStatus('ìš”ì†Œ ì„ íƒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message, 'error');
            console.error(error);
        }
    }

    async function setAltTextForSelected() {
        const altText = document.getElementById('altText').value.trim();

        if (!altText) {
            showStatus('ëŒ€ì²´ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        try {
            await PowerPoint.run(async (context) => {
                const selectedShapes = context.presentation.getSelectedShapes();
                const shapeCount = selectedShapes.getCount();

                await context.sync();

                if (shapeCount.value === 0) {
                    showStatus('ìš”ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                selectedShapes.load("items");
                await context.sync();

                // PowerPoint APIëŠ” í˜„ì¬ alt text ì§ì ‘ ì„¤ì •ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
                // í•˜ì§€ë§Œ ì´ë¦„ì„ í†µí•´ ì‹ë³„í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤
                for (let shape of selectedShapes.items) {
                    // ì´ë¦„ì— [ALT: ] ì ‘ë‘ì‚¬ë¥¼ ì¶”ê°€í•˜ì—¬ ëŒ€ì²´ í…ìŠ¤íŠ¸ë¥¼ í‘œì‹œ
                    const currentName = shape.name;
                    // ê¸°ì¡´ ALT íƒœê·¸ ì œê±°
                    const baseName = currentName.replace(/\[ALT:.*?\]\s*/, '');
                    shape.name = `[ALT: ${altText}] ${baseName}`;
                }

                await context.sync();

                showStatus(`${shapeCount.value}ê°œ ìš”ì†Œì— ëŒ€ì²´ í…ìŠ¤íŠ¸ë¥¼ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.`, 'success');

                // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await analyzeSlide();
            });
        } catch (error) {
            showStatus('ëŒ€ì²´ í…ìŠ¤íŠ¸ ì„¤ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message, 'error');
            console.error(error);
        }
    }

    async function applyRulesToAll(onlyEmpty) {
        const ruleType = document.getElementById('ruleType').value;

        try {
            await PowerPoint.run(async (context) => {
                const slides = context.presentation.slides;
                const slide = slides.getItemAt(0);
                const shapes = slide.shapes;

                shapes.load("items");
                await context.sync();

                let count = 0;

                for (let i = 0; i < shapes.items.length; i++) {
                    const shape = shapes.items[i];
                    shape.load("name,type");
                    await context.sync();

                    const currentName = shape.name;
                    const hasAlt = currentName.includes('[ALT:');

                    // onlyEmptyê°€ trueë©´ ëŒ€ì²´ í…ìŠ¤íŠ¸ê°€ ì—†ëŠ” ê²ƒë§Œ ì²˜ë¦¬
                    if (onlyEmpty && hasAlt) {
                        continue;
                    }

                    const baseName = currentName.replace(/\[ALT:.*?\]\s*/, '');
                    let altText = '';

                    switch (ruleType) {
                        case 'prefix':
                            const prefix = document.getElementById('prefix').value;
                            altText = prefix + baseName;
                            break;

                        case 'type':
                            const typeName = getShapeTypeName(shape.type);
                            altText = `${typeName}: ${baseName}`;
                            break;

                        case 'custom':
                            const template = document.getElementById('customTemplate').value;
                            altText = template
                                .replace('{name}', baseName)
                                .replace('{type}', getShapeTypeName(shape.type))
                                .replace('{index}', i + 1);
                            break;
                    }

                    shape.name = `[ALT: ${altText}] ${baseName}`;
                    count++;
                }

                await context.sync();

                showStatus(`${count}ê°œ ìš”ì†Œì— ê·œì¹™ì„ ì ìš©í–ˆìŠµë‹ˆë‹¤.`, 'success');

                // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await analyzeSlide();
            });
        } catch (error) {
            showStatus('ê·œì¹™ ì ìš© ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message, 'error');
            console.error(error);
        }
    }
</script>

</html>
